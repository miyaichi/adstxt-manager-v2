# Feature Spec: Insite Analytics AI Adviser

## 1. 概要
Insite Analyticsに、AI（Gemini）を活用した「ドメイン診断・改善アドバイス機能」を追加します。
OpenSincera APIから取得したパブリッシャーのメトリクス（UX、広告密度、サプライチェーン品質など）をAIが解析し、広告主（バイヤー）視点での評価と具体的な改善策を提示します。

## 2. 実現可能性と前提条件
- **データソース**: OpenSincera APIから取得可能なパブリッシャーデータを利用します。特に `similar_publishers` フィールドに含まれるID群を利用し、競合/類似サイトとの相対比較を行います。
- **AIモデル**: Google Gemini (Flash or Pro) を利用。
- **ベンチマークについて**: 単なる絶対値評価だけでなく、`similar_publishers` から上位数サイトのデータを取得・平均化することで、「類似サイトと比較してどうか」という相対的な立ち位置（偏差）を評価に組み込みます。

## 3. 提供機能と主な分析軸
AIは以下の3つの観点でデータを分析し、レポートを生成します。

### A. UX・技術的健全性 (Technical Health)
ユーザー体験を損なう技術的な要因を指摘します。
- **関連指標**: `avg_page_weight` (ページ重量), `avg_cpu` (CPU負荷)
- **分析内容**: ページの重さが読み込み速度やSEOに与える悪影響、CPU負荷によるブラウザクラッシュのリスクなどを、類似サイト平均と比較して評価。

### B. 広告品質と在庫リスク (Ad Quality & Risk)
広告主が忌避する「MFA (Made for Advertising)」判定のリスクを評価します。
- **関連指標**: `avg_ads_to_content_ratio` (広告対コンテンツ比), `avg_ad_refresh` (リフレッシュ頻度), `avg_ads_in_view` (視認性)
- **分析内容**: 広告枠が過剰でないか（アロケーションの適正化）、リフレッシュがアグレッシブすぎて視認性を下げていないか等を診断。

### C. サプライチェーンの信頼性 (Supply Chain Transparency)
SPO (Supply Path Optimization) の観点から、買い付けやすい経路になっているかを評価します。
- **関連指標**: `reseller_count` (中間業者の数), `id_absorption_rate` (ID欠損率/吸収率), `sellers.json` status
- **分析内容**: 中間業者が多すぎてマージンが抜かれていないか、IDが正しくバイヤーに届いているか（マッチ率への影響）を解説。

## 4. 処理フロー (Technical Workflow)
1. **Data Fetching (Target)**: フロントエンドがOpenSincera APIから対象ドメインのデータを取得。
2. **Data Fetching (Benchmark)**: レスポンスに含まれる `similar_publishers` のIDリストから、上位3〜5件のパブリッシャーデータを並行して取得し、平均値（ベンチマーク）を算出。
3. **Context Construction**: 対象サイトの数値と、算出された「類似サイト平均値」をプロンプトに埋め込み。
4. **AI Inference**: Backend (またはEdge) からGemini APIをコール。
5. **Rendering**: AIからのMarkdownレスポンスをフロントエンドで整形表示。

## 5. System Prompt 設計案

Geminiに入力するプロンプト構成です。

### Role Definition
> あなたはプログラマティック広告の収益化とWebパフォーマンス最適化のエキスパートです。
> 広告主（DSP/バイヤー）の視点から、提示されたWebサイト（パブリッシャー）の価値を評価し、収益と品質を向上させるための辛口かつ建設的なコンサルティングを行ってください。

### Input Context
提供されるデータには、対象サイトの数値と、**類似したカテゴリのサイト平均値（Benchmark）**が含まれます。相対的な評価を重視してください。

指標定義：
- `avg_ads_to_content_ratio`: コンテンツに対する広告エリアの比率（高いほどMFAのリスク）
- `avg_page_weight`: ページのデータ転送量（MB）
- `avg_ad_refresh`: 広告の平均更新時間（秒）。短い場合、視認性が低い可能性。
- `reseller_count`: ads.txt/sellers.jsonで確認された再販業者の数。多い場合、サプライチェーンが不透明。
- `id_absorption_rate`: 非直接的な取引におけるIDの到達率。低い場合、オーディエンスデータが活用できていない。

### Output Requirements
以下の構成で、日本語のMarkdown形式で出力してください。

#### 1. 総合評価 (Executive Summary)
- サイトの状態を一言で表すキャッチフレーズ
- 推定される「バイヤーからの印象」（例：安全だが在庫品質が低い、技術的負債がある、プレミアムな在庫である等）
- **類似サイトとの比較**: カテゴリ平均と比較して、優れている点・劣っている点を簡潔に記述。

#### 2. 重要課題トップ3 (Priority Actions)
- データから読み取れる最も改善効果が高い3つのアクション。
- 具体的な数値（例：「現在のA2CR 40%は、類似サイト平均の25%と比較しても著しく高いです」）を引用すること。

#### 3. 詳細分析
- **UXとパフォーマンス**: ページ重量とCPU負荷に基づく、ユーザー体験（直帰率等）への影響。
- **広告設定**: リフレッシュ設定や密度が、CPMやFill Rateに与えているであろう影響の考察。
- **サプライチェーン**: 中間業者の整理（SPO）やads.txtの整理による収益性改善の提案。

#### 4. まとめ
- この改善を実行した場合に期待できる将来像。

## 6. UIイメージ
- **トリガー**: Insite Analyticsの詳細ページに「AI診断を実行」ボタンを配置。
- **表示**: ボタン押下後、ローディングアニメーションを経て、診断結果がMarkdown形式で下部に展開される。
